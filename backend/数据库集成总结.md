# MySQL æ•°æ®åº“é›†æˆå®Œæˆæ€»ç»“

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. ä¾èµ–åŒ…ç®¡ç†
- âœ“ æ·»åŠ  `SQLAlchemy` (ORMæ¡†æ¶)
- âœ“ æ·»åŠ  `PyMySQL` (MySQLé©±åŠ¨)
- âœ“ æ·»åŠ  `cryptography` (åŠ å¯†æ”¯æŒ)
- âœ“ æ›´æ–° `requirements.txt`

### 2. é…ç½®ç³»ç»Ÿ
- âœ“ åˆ›å»º `config.py` - ç»Ÿä¸€é…ç½®ç®¡ç†
- âœ“ åˆ›å»º `.env` - ç¯å¢ƒå˜é‡é…ç½®æ–‡ä»¶
- âœ“ æ”¯æŒæ•°æ®åº“è¿æ¥å‚æ•°é…ç½®
- âœ“ æ”¯æŒæœåŠ¡å™¨å‚æ•°é…ç½®

### 3. æ•°æ®åº“æ¨¡å‹
- âœ“ åˆ›å»º `models.py` - æ•°æ®æ¨¡å‹å®šä¹‰
- âœ“ å®šä¹‰ `SensorData` è¡¨ç»“æ„
- âœ“ åŒ…å«å­—æ®µï¼šid, counter, adc, voltage, timestamp, source_ip
- âœ“ æ·»åŠ ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- âœ“ å®ç° `to_dict()` æ–¹æ³•ç”¨äºJSONåºåˆ—åŒ–

### 4. æ•°æ®åº“æ“ä½œå±‚
- âœ“ åˆ›å»º `database.py` - CRUDæ“ä½œå°è£…
- âœ“ å®ç°æ•°æ®åº“å¼•æ“å’Œä¼šè¯ç®¡ç†
- âœ“ å®ç° `init_db()` åˆå§‹åŒ–å‡½æ•°
- âœ“ å®ç° `SensorDataCRUD` æ“ä½œç±»
  - âœ“ `create()` - æ’å…¥æ–°è®°å½•
  - âœ“ `get_latest()` - è·å–æœ€æ–°Næ¡è®°å½•
  - âœ“ `get_by_id()` - æ ¹æ®IDæŸ¥è¯¢
  - âœ“ `get_by_time_range()` - æ—¶é—´èŒƒå›´æŸ¥è¯¢
  - âœ“ `get_recent_hours()` - è·å–æœ€è¿‘Nå°æ—¶æ•°æ®
  - âœ“ `get_count()` - ç»Ÿè®¡è®°å½•æ•°
  - âœ“ `delete_old_data()` - æ¸…ç†æ—§æ•°æ®

### 5. FastAPIé›†æˆ
- âœ“ ä¿®æ”¹ `main.py` é›†æˆæ•°æ®åº“åŠŸèƒ½
- âœ“ åœ¨å¯åŠ¨æ—¶è‡ªåŠ¨åˆå§‹åŒ–æ•°æ®åº“
- âœ“ UDPæ¥æ”¶æ•°æ®æ—¶è‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“
- âœ“ è®°å½•æ¥æºIPåœ°å€
- âœ“ æ·»åŠ å¼‚å¸¸å¤„ç†ï¼Œæ•°æ®åº“é”™è¯¯ä¸å½±å“å®æ—¶åŠŸèƒ½

### 6. RESTful APIæ¥å£
- âœ“ `GET /api/latest` - å®æ—¶æ•°æ®
- âœ“ `GET /api/data/recent` - æœ€è¿‘Næ¡è®°å½•
- âœ“ `GET /api/data/hours` - æœ€è¿‘Nå°æ—¶æ•°æ®
- âœ“ `GET /api/data/range` - æ—¶é—´èŒƒå›´æŸ¥è¯¢
- âœ“ `GET /api/data/{id}` - å•æ¡è®°å½•æŸ¥è¯¢
- âœ“ `GET /api/stats` - ç»Ÿè®¡ä¿¡æ¯
- âœ“ `DELETE /api/data/cleanup` - æ•°æ®æ¸…ç†
- âœ“ æ‰€æœ‰æ¥å£æ”¯æŒå‚æ•°éªŒè¯
- âœ“ ç»Ÿä¸€çš„JSONå“åº”æ ¼å¼

### 7. å·¥å…·å’Œè„šæœ¬
- âœ“ `init_database.py` - æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
- âœ“ `test_database.py` - è¿æ¥æµ‹è¯•è„šæœ¬
- âœ“ `example_usage.py` - APIä½¿ç”¨ç¤ºä¾‹
- âœ“ `start_server.bat` - å¯åŠ¨è„šæœ¬ï¼ˆWindowsï¼‰

### 8. æ–‡æ¡£
- âœ“ æ›´æ–°ä¸» `README.md`
- âœ“ æ·»åŠ æ•°æ®åº“é…ç½®è¯´æ˜
- âœ“ æ·»åŠ APIæ¥å£æ–‡æ¡£
- âœ“ åˆ›å»º `æ•°æ®åº“ä½¿ç”¨è¯´æ˜.md`
- âœ“ åˆ›å»º `QUICK_START_DATABASE.md`
- âœ“ æ›´æ–°é¡¹ç›®æ–‡ä»¶ç»“æ„è¯´æ˜

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§

### 1. è‡ªåŠ¨åŒ–
- æœåŠ¡å™¨å¯åŠ¨æ—¶è‡ªåŠ¨åˆå§‹åŒ–æ•°æ®åº“è¡¨
- UDPæ¥æ”¶æ•°æ®æ—¶è‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“
- è¿æ¥æ± è‡ªåŠ¨ç®¡ç†ï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†

### 2. å¯é æ€§
- æ•°æ®åº“è¿æ¥å¤±è´¥ä¸å½±å“å®æ—¶åŠŸèƒ½
- å®Œå–„çš„å¼‚å¸¸å¤„ç†
- è¿æ¥æ± å¥åº·æ£€æŸ¥

### 3. æ€§èƒ½ä¼˜åŒ–
- ä½¿ç”¨ç´¢å¼•åŠ é€ŸæŸ¥è¯¢
- è¿æ¥æ± å¤ç”¨è¿æ¥
- å¼‚æ­¥å¤„ç†ä¸é˜»å¡ä¸»æµç¨‹

### 4. æ˜“ç”¨æ€§
- ç»Ÿä¸€çš„é…ç½®ç®¡ç†
- ä¸°å¯Œçš„æŸ¥è¯¢æ¥å£
- å®Œæ•´çš„ä½¿ç”¨ç¤ºä¾‹
- è‡ªåŠ¨ç”Ÿæˆçš„APIæ–‡æ¡£

## ğŸ“Š æ•°æ®æµç¨‹

```
ESP8266 (UDP) 
    â†“
FastAPI UDPæœåŠ¡å™¨
    â†“
è§£æJSONæ•°æ®
    â†“
    â”œâ”€â†’ ä¿å­˜åˆ°MySQLæ•°æ®åº“ (æŒä¹…åŒ–)
    â”‚
    â””â”€â†’ å¹¿æ’­åˆ°WebSocket (å®æ—¶)
        â†“
    å‰ç«¯Vue.js
```

## ğŸ”§ æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         FastAPI åº”ç”¨å±‚                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  UDP Server  â”‚  WebSocket  â”‚  HTTP API  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         SQLAlchemy ORM å±‚                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         PyMySQL é©±åŠ¨å±‚                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         MySQL æ•°æ®åº“                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ˆ æ•°æ®åº“è¡¨è®¾è®¡

### sensor_data è¡¨

```sql
CREATE TABLE sensor_data (
    id INT AUTO_INCREMENT PRIMARY KEY,
    counter INT NOT NULL COMMENT 'æ•°æ®è®¡æ•°å™¨',
    adc INT NOT NULL COMMENT 'ADCåŸå§‹å€¼',
    voltage FLOAT NOT NULL COMMENT 'ç”µå‹å€¼',
    timestamp DATETIME NOT NULL COMMENT 'æ¥æ”¶æ—¶é—´',
    source_ip VARCHAR(50) COMMENT 'æ¥æºIP',
    INDEX idx_timestamp (timestamp)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. é…ç½®æ•°æ®åº“
```bash
# ç¼–è¾‘ backend/.env
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=ä½ çš„å¯†ç 
DB_NAME=spacenose
```

### 2. åˆå§‹åŒ–æ•°æ®åº“
```bash
cd backend
python init_database.py
```

### 3. æµ‹è¯•è¿æ¥
```bash
python test_database.py
```

### 4. å¯åŠ¨æœåŠ¡å™¨
```bash
python main.py
# æˆ–ä½¿ç”¨å¯åŠ¨è„šæœ¬
..\start_server.bat
```

### 5. æŸ¥è¯¢æ•°æ®
```bash
# æ–¹æ³•1: ä½¿ç”¨API
curl http://localhost:8000/api/data/recent?limit=10

# æ–¹æ³•2: è¿è¡Œç¤ºä¾‹
python example_usage.py

# æ–¹æ³•3: è®¿é—®APIæ–‡æ¡£
æµè§ˆå™¨æ‰“å¼€ http://localhost:8000/docs
```

## ğŸ“ APIä½¿ç”¨ç¤ºä¾‹

### Python
```python
import requests

# è·å–æœ€è¿‘100æ¡æ•°æ®
response = requests.get('http://localhost:8000/api/data/recent?limit=100')
data = response.json()

for item in data['data']:
    print(f"ç”µå‹: {item['voltage']}V, æ—¶é—´: {item['timestamp']}")
```

### JavaScript
```javascript
// è·å–ç»Ÿè®¡ä¿¡æ¯
fetch('http://localhost:8000/api/stats')
  .then(response => response.json())
  .then(data => {
    console.log('æ€»è®°å½•æ•°:', data.total_records);
    console.log('æœ€æ–°è®°å½•:', data.latest_record);
  });
```

### cURL
```bash
# è·å–æœ€è¿‘1å°æ—¶çš„æ•°æ®
curl "http://localhost:8000/api/data/hours?hours=1"

# æ¸…ç†30å¤©å‰çš„æ•°æ®
curl -X DELETE "http://localhost:8000/api/data/cleanup?days=30"
```

## ğŸ“ æœ€ä½³å®è·µ

### 1. å®šæœŸç»´æŠ¤
```python
# å®šæœŸæ¸…ç†æ—§æ•°æ®
import schedule
import requests

def cleanup_old_data():
    requests.delete('http://localhost:8000/api/data/cleanup?days=30')

schedule.every().day.at("03:00").do(cleanup_old_data)
```

### 2. æ•°æ®å¤‡ä»½
```bash
# å¤‡ä»½æ•°æ®åº“
mysqldump -u root -p spacenose > backup_$(date +%Y%m%d).sql

# æ¢å¤æ•°æ®åº“
mysql -u root -p spacenose < backup_20240101.sql
```

### 3. ç›‘æ§æ•°æ®åº“å¤§å°
```sql
SELECT 
    table_name,
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS 'Size (MB)'
FROM information_schema.TABLES
WHERE table_schema = 'spacenose';
```

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜1: æ•°æ®åº“è¿æ¥å¤±è´¥
```bash
# è¿è¡Œæµ‹è¯•è„šæœ¬æŸ¥çœ‹è¯¦ç»†é”™è¯¯
python test_database.py
```

### é—®é¢˜2: æ•°æ®æœªä¿å­˜
æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ï¼Œæœç´¢ `âš  æ•°æ®åº“ä¿å­˜å¤±è´¥` æˆ– `âœ—` æ ‡è®°

### é—®é¢˜3: æŸ¥è¯¢ç¼“æ…¢
- æ£€æŸ¥æ•°æ®é‡ï¼Œè€ƒè™‘æ·»åŠ ç´¢å¼•
- ä½¿ç”¨æ—¶é—´èŒƒå›´æŸ¥è¯¢ä»£æ›¿æŸ¥è¯¢å…¨éƒ¨æ•°æ®
- å®šæœŸæ¸…ç†æ—§æ•°æ®

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ•°æ®åº“ä½¿ç”¨è¯´æ˜](./æ•°æ®åº“ä½¿ç”¨è¯´æ˜.md) - è¯¦ç»†çš„ä½¿ç”¨æŒ‡å—
- [å¿«é€Ÿå¼€å§‹æŒ‡å—](./QUICK_START_DATABASE.md) - 3åˆ†é’Ÿå¿«é€Ÿé…ç½®
- [APIæ–‡æ¡£](http://localhost:8000/docs) - è‡ªåŠ¨ç”Ÿæˆçš„äº¤äº’å¼APIæ–‡æ¡£
- [ä¸»README](../README.md) - é¡¹ç›®æ€»ä½“ä»‹ç»

## ğŸ‰ æ€»ç»“

MySQLæ•°æ®åº“å·²æˆåŠŸé›†æˆåˆ°æ˜Ÿé™…å—…æ¢è€…é¡¹ç›®ä¸­ï¼Œå®ç°äº†ï¼š

âœ… **æ•°æ®æŒä¹…åŒ–** - æ‰€æœ‰ä¼ æ„Ÿå™¨æ•°æ®è‡ªåŠ¨ä¿å­˜  
âœ… **å†å²æŸ¥è¯¢** - æ”¯æŒå¤šç§æ–¹å¼æŸ¥è¯¢å†å²æ•°æ®  
âœ… **RESTful API** - æä¾›æ ‡å‡†åŒ–çš„æ•°æ®è®¿é—®æ¥å£  
âœ… **æ˜“äºä½¿ç”¨** - å®Œå–„çš„æ–‡æ¡£å’Œç¤ºä¾‹ä»£ç   
âœ… **é«˜å¯é æ€§** - å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶  

é¡¹ç›®ç°åœ¨å…·å¤‡äº†å®Œæ•´çš„æ•°æ®é‡‡é›†ã€ä¼ è¾“ã€å­˜å‚¨ã€æŸ¥è¯¢å’Œå±•ç¤ºèƒ½åŠ›ï¼ğŸš€

