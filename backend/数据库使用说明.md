# æ•°æ®åº“ä½¿ç”¨è¯´æ˜

## ğŸ“‹ ç›®å½•
1. [æ•°æ®åº“é…ç½®](#æ•°æ®åº“é…ç½®)
2. [æ•°æ®åº“åˆå§‹åŒ–](#æ•°æ®åº“åˆå§‹åŒ–)
3. [æ•°æ®è¡¨ç»“æ„](#æ•°æ®è¡¨ç»“æ„)
4. [APIæ¥å£è¯´æ˜](#apiæ¥å£è¯´æ˜)
5. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## æ•°æ®åº“é…ç½®

### 1. å®‰è£…MySQL

ç¡®ä¿ç³»ç»Ÿå·²å®‰è£… MySQL æ•°æ®åº“æœåŠ¡ï¼š
- **ä¸‹è½½åœ°å€**: https://dev.mysql.com/downloads/mysql/
- **æ¨èç‰ˆæœ¬**: MySQL 8.0 æˆ–ä»¥ä¸Š

### 2. é…ç½®ç¯å¢ƒå˜é‡

ç¼–è¾‘ `backend/.env` æ–‡ä»¶ï¼Œè®¾ç½®æ•°æ®åº“è¿æ¥å‚æ•°ï¼š

```env
# æ•°æ®åº“é…ç½®
DB_HOST=localhost          # æ•°æ®åº“ä¸»æœºåœ°å€
DB_PORT=3306              # æ•°æ®åº“ç«¯å£
DB_USER=root              # æ•°æ®åº“ç”¨æˆ·å
DB_PASSWORD=mwYgR7#*X2 # æ•°æ®åº“å¯†ç 
DB_NAME=spacenose         # æ•°æ®åº“åç§°

# æœåŠ¡å™¨é…ç½®
UDP_HOST=0.0.0.0
UDP_PORT=8888
SERVER_HOST=0.0.0.0
SERVER_PORT=8000
```

---

## æ•°æ®åº“åˆå§‹åŒ–

### æ–¹æ³•1: ä½¿ç”¨åˆå§‹åŒ–è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
cd backend
python init_database.py
```

è¯¥è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
1. åˆ›å»ºæ•°æ®åº“ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
2. åˆ›å»ºæ•°æ®è¡¨ç»“æ„
3. è®¾ç½®å­—ç¬¦é›†ä¸º utf8mb4

### æ–¹æ³•2: æ‰‹åŠ¨åˆ›å»º

1. ç™»å½•MySQLï¼š
```bash
mysql -u root -p
```

2. åˆ›å»ºæ•°æ®åº“ï¼š
```sql
CREATE DATABASE spacenose CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE spacenose;
```

3. å¯åŠ¨FastAPIæœåŠ¡å™¨ï¼Œè¡¨ç»“æ„ä¼šè‡ªåŠ¨åˆ›å»ºã€‚

---

## æ•°æ®è¡¨ç»“æ„

### sensor_data è¡¨

å­˜å‚¨æ‰€æœ‰ä¼ æ„Ÿå™¨æ•°æ®è®°å½•ã€‚

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | å¤‡æ³¨ |
|:-------|:-----|:-----|:-----|
| `id` | INT | ä¸»é”®ID | è‡ªå¢ |
| `counter` | INT | æ•°æ®è®¡æ•°å™¨ | STM32å‘é€çš„åºåˆ—å· |
| `adc` | INT | ADCåŸå§‹å€¼ | 0-4095 |
| `voltage` | FLOAT | ç”µå‹å€¼ | å•ä½ï¼šä¼ç‰¹(V) |
| `timestamp` | DATETIME | æ¥æ”¶æ—¶é—´ | æœåŠ¡å™¨æ—¶é—´æˆ³ |
| `source_ip` | VARCHAR(50) | æ¥æºIP | ESP8266çš„IPåœ°å€ |

**ç´¢å¼•ï¼š**
- ä¸»é”®ç´¢å¼•ï¼š`id`
- æ—¶é—´ç´¢å¼•ï¼š`timestamp`ï¼ˆç”¨äºæ—¶é—´èŒƒå›´æŸ¥è¯¢ä¼˜åŒ–ï¼‰

---

## APIæ¥å£è¯´æ˜

### 1. è·å–æœ€è¿‘Næ¡æ•°æ®

**æ¥å£**: `GET /api/data/recent`

**å‚æ•°**:
- `limit`: è¿”å›çš„æ•°æ®æ¡æ•°ï¼Œé»˜è®¤100ï¼ŒèŒƒå›´1-1000

**ç¤ºä¾‹**:
```bash
curl "http://localhost:8000/api/data/recent?limit=50"
```

**å“åº”**:
```json
{
  "success": true,
  "count": 50,
  "data": [
    {
      "id": 100,
      "counter": 100,
      "adc": 2048,
      "voltage": 1.65,
      "timestamp": "2024-01-01 12:00:00",
      "source_ip": "192.168.137.100"
    }
  ]
}
```

### 2. è·å–æœ€è¿‘Nå°æ—¶çš„æ•°æ®

**æ¥å£**: `GET /api/data/hours`

**å‚æ•°**:
- `hours`: æœ€è¿‘çš„å°æ—¶æ•°ï¼Œé»˜è®¤1ï¼ŒèŒƒå›´1-24

**ç¤ºä¾‹**:
```bash
curl "http://localhost:8000/api/data/hours?hours=2"
```

### 3. æ ¹æ®æ—¶é—´èŒƒå›´æŸ¥è¯¢

**æ¥å£**: `GET /api/data/range`

**å‚æ•°**:
- `start`: å¼€å§‹æ—¶é—´ï¼Œæ ¼å¼ `YYYY-MM-DD HH:MM:SS`
- `end`: ç»“æŸæ—¶é—´ï¼Œæ ¼å¼ `YYYY-MM-DD HH:MM:SS`

**ç¤ºä¾‹**:
```bash
curl "http://localhost:8000/api/data/range?start=2024-01-01%2010:00:00&end=2024-01-01%2012:00:00"
```

### 4. æ ¹æ®IDè·å–å•æ¡æ•°æ®

**æ¥å£**: `GET /api/data/{id}`

**ç¤ºä¾‹**:
```bash
curl "http://localhost:8000/api/data/123"
```

### 5. è·å–ç»Ÿè®¡ä¿¡æ¯

**æ¥å£**: `GET /api/stats`

**å“åº”**:
```json
{
  "success": true,
  "total_records": 1000,
  "latest_record": {
    "id": 1000,
    "counter": 1000,
    "voltage": 1.65,
    "timestamp": "2024-01-01 12:00:00"
  },
  "database": "spacenose"
}
```

### 6. æ¸…ç†æ—§æ•°æ®

**æ¥å£**: `DELETE /api/data/cleanup`

**å‚æ•°**:
- `days`: åˆ é™¤Nå¤©å‰çš„æ•°æ®ï¼Œé»˜è®¤30ï¼ŒèŒƒå›´1-365

**ç¤ºä¾‹**:
```bash
curl -X DELETE "http://localhost:8000/api/data/cleanup?days=30"
```

---

## å¸¸è§é—®é¢˜

### Q1: æ•°æ®åº“è¿æ¥å¤±è´¥

**ç—‡çŠ¶**: å¯åŠ¨æœåŠ¡å™¨æ—¶æ˜¾ç¤º `âš  æ•°æ®åº“è¿æ¥å¤±è´¥`

**è§£å†³æ–¹æ³•**:
1. ç¡®è®¤MySQLæœåŠ¡å·²å¯åŠ¨
2. æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„æ•°æ®åº“é…ç½®
3. ç¡®è®¤æ•°æ®åº“ç”¨æˆ·åå’Œå¯†ç æ­£ç¡®
4. ç¡®è®¤é˜²ç«å¢™æœªé˜»æ­¢3306ç«¯å£

### Q2: è¡¨å·²å­˜åœ¨é”™è¯¯

**ç—‡çŠ¶**: `Table 'sensor_data' already exists`

**è§£å†³æ–¹æ³•**:
è¿™ä¸æ˜¯é”™è¯¯ï¼Œè¡¨å·²ç»å­˜åœ¨è¯´æ˜ä¹‹å‰å·²åˆå§‹åŒ–è¿‡ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚

### Q3: æ•°æ®æœªä¿å­˜åˆ°æ•°æ®åº“

**ç—‡çŠ¶**: å®æ—¶æ•°æ®æ­£å¸¸ï¼Œä½†æ•°æ®åº“æ— è®°å½•

**è§£å†³æ–¹æ³•**:
1. æ£€æŸ¥æ§åˆ¶å°æ˜¯å¦æœ‰ `âš  æ•°æ®åº“ä¿å­˜å¤±è´¥` çš„é”™è¯¯ä¿¡æ¯
2. ç¡®è®¤æ•°æ®åº“è¿æ¥æ­£å¸¸
3. æ£€æŸ¥æ•°æ®åº“ç”¨æˆ·æ˜¯å¦æœ‰å†™å…¥æƒé™

### Q4: å¦‚ä½•æŸ¥çœ‹æ•°æ®åº“å†…å®¹

**æ–¹æ³•1**: ä½¿ç”¨MySQLå‘½ä»¤è¡Œ
```bash
mysql -u root -p
USE spacenose;
SELECT * FROM sensor_data ORDER BY id DESC LIMIT 10;
```

**æ–¹æ³•2**: ä½¿ç”¨APIæ¥å£
```bash
curl "http://localhost:8000/api/data/recent?limit=10"
```

**æ–¹æ³•3**: ä½¿ç”¨å›¾å½¢åŒ–å·¥å…·
- MySQL Workbench
- phpMyAdmin
- Navicat

### Q5: å¦‚ä½•å¤‡ä»½æ•°æ®åº“

```bash
mysqldump -u root -p spacenose > backup.sql
```

### Q6: å¦‚ä½•æ¢å¤æ•°æ®åº“

```bash
mysql -u root -p spacenose < backup.sql
```

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **å®šæœŸæ¸…ç†æ—§æ•°æ®**: ä½¿ç”¨ `/api/data/cleanup` æ¥å£å®šæœŸæ¸…ç†å†å²æ•°æ®
2. **æ·»åŠ ç´¢å¼•**: å¦‚æœéœ€è¦æŒ‰å…¶ä»–å­—æ®µæŸ¥è¯¢ï¼Œå¯æ·»åŠ ç›¸åº”ç´¢å¼•
3. **è¿æ¥æ± **: å½“å‰å·²é…ç½®è¿æ¥æ± ï¼Œæ— éœ€é¢å¤–è®¾ç½®
4. **æ•°æ®å½’æ¡£**: å¯¹äºé•¿æœŸä¿å­˜çš„æ•°æ®ï¼Œå»ºè®®å®šæœŸå½’æ¡£åˆ°å†å²è¡¨

---

## æ•°æ®åº“ç»´æŠ¤

### æŸ¥çœ‹è¡¨ä¿¡æ¯
```sql
DESCRIBE sensor_data;
```

### æŸ¥çœ‹è¡¨å¤§å°
```sql
SELECT 
    table_name,
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS "Size (MB)"
FROM information_schema.TABLES
WHERE table_schema = "spacenose";
```

### ä¼˜åŒ–è¡¨
```sql
OPTIMIZE TABLE sensor_data;
```

---

å¦‚æœ‰å…¶ä»–é—®é¢˜ï¼Œè¯·å‚è€ƒé¡¹ç›®ä¸» README æˆ–æŸ¥çœ‹ FastAPI è‡ªåŠ¨ç”Ÿæˆçš„æ–‡æ¡£ï¼š
**http://localhost:8000/docs**

