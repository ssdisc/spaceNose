# 星际嗅探者 - STM32 到前端的完整数据传输方案

## 📋 系统架构

```
STM32F407 (传感器数据采集)
    ↓ UART串口通信
ESP8266 (WiFi模块)
    ↓ UDP协议 (WiFi网络)
电脑WiFi热点
    ↓ UDP Socket
FastAPI后端服务器 (Python)
    ↓ WebSocket
Vue前端 (浏览器)
```

## 🔧 硬件配置

### STM32 连接说明
- **UART1** (PA9-TX, PA10-RX): 调试串口，用于查看日志
- **UART2** (PA2-TX, PA3-RX): 连接ESP8266
- **ADC1 CH0** (PA0): 传感器输入

### ESP8266 连接说明
```
ESP8266    →    STM32F407
TX         →    PA3 (UART2_RX)
RX         →    PA2 (UART2_TX)
VCC        →    3.3V (注意：需要足够电流，建议使用外部电源)
GND        →    GND
CH_PD      →    3.3V (使能引脚必须接高电平)
```

## 💻 软件配置

### 1. STM32 配置

#### 修改WiFi热点信息（src/main.c 第112-113行）
```c
const char* wifi_ssid = "你的热点名称";
const char* wifi_password = "你的热点密码";
```

#### 修改服务器IP地址（src/main.c 第124行）
```c
const char* server_ip = "192.168.137.1";  // 改为你电脑的实际IP
```

**如何查看电脑IP地址：**
1. Windows: 打开CMD，输入 `ipconfig`
2. 查找 "无线局域网适配器 本地连接* X" 或 "以太网适配器"
3. 找到IPv4地址，通常是 `192.168.137.1` 或 `192.168.43.1`

### 2. 后端服务器配置

#### 安装依赖
```bash
cd backend
pip install -r requirements.txt
```

#### 启动服务器
```bash
python main.py
```

服务器将在以下端口启动：
- HTTP服务: `http://0.0.0.0:8000`
- UDP接收: `0.0.0.0:8888`
- WebSocket: `ws://0.0.0.0:8000/ws`

### 3. 前端配置

#### 安装依赖（首次运行）
```bash
cd web
npm install
```

#### 开发模式运行
```bash
npm run serve
```

#### 生产构建
```bash
npm run build
```

构建完成后，前端文件会生成到 `web/dist` 目录，可以直接通过后端服务器访问。

## 🚀 使用步骤

### Step 1: 开启电脑WiFi热点
1. Windows 10/11: 设置 → 网络和Internet → 移动热点 → 开启
2. 记住热点名称和密码

### Step 2: 配置并烧录STM32程序
1. 在 `src/main.c` 中修改WiFi热点信息和服务器IP
2. 使用PlatformIO或Keil编译并烧录程序
3. 通过串口监视器查看启动日志

### Step 3: 启动后端服务器
```bash
cd backend
python main.py
```

你应该看到：
```
========================================
  星际嗅探者 - 后端服务器启动
  HTTP服务: http://127.0.0.1:8000
  UDP服务: 0.0.0.0:8888
  WebSocket: ws://127.0.0.1:8000/ws
========================================
✓ UDP服务器启动在 0.0.0.0:8888
```

### Step 4: 打开前端页面
1. 在浏览器中访问 `http://localhost:8000`
2. 等待WebSocket连接成功（状态指示灯变绿）

### Step 5: 观察数据
- 页面上会实时显示：
  - ADC原始值
  - 电压值
  - 数据计数
  - 实时趋势图表
  - 数据日志

## 📊 数据格式

### STM32 发送的数据（JSON格式）
```json
{
  "counter": 123,
  "adc": 2048,
  "voltage": 1.650
}
```

### 后端转发给前端的数据（添加时间戳）
```json
{
  "counter": 123,
  "adc": 2048,
  "voltage": 1.650,
  "timestamp": "2025-11-10 15:30:45"
}
```

## 🔍 故障排查

### STM32无法连接ESP8266
检查：
1. ESP8266供电是否稳定（需要200-300mA）
2. TX/RX是否交叉连接
3. CH_PD引脚是否接3.3V
4. 串口波特率是否为115200

### ESP8266无法连接WiFi
检查：
1. WiFi热点是否已开启
2. WiFi名称和密码是否正确
3. 热点是否为2.4GHz（ESP8266不支持5GHz）
4. ESP8266与热点距离是否过远

### UDP数据无法到达服务器
检查：
1. 服务器IP地址是否正确
2. 防火墙是否阻止了UDP端口8888
3. 服务器是否已启动
4. 使用 `netstat -an | findstr 8888` 检查端口是否在监听

### 前端无法连接WebSocket
检查：
1. 后端服务器是否正在运行
2. 浏览器控制台是否有错误信息
3. WebSocket URL是否正确（检查端口号）

## 🎯 性能优化建议

1. **降低发送频率**: 如果不需要每秒发送数据，可以增加 `HAL_Delay` 时间
2. **批量发送**: 可以累积多个数据点后一次性发送
3. **数据压缩**: 对于大量数据，可以使用二进制格式代替JSON

## 📝 扩展功能建议

1. **数据存储**: 在后端添加数据库，保存历史数据
2. **数据分析**: 添加数据分析功能（平均值、最大值、最小值等）
3. **报警功能**: 当数据超过阈值时发送通知
4. **多设备支持**: 支持多个STM32设备同时连接
5. **用户认证**: 添加登录功能，保护数据安全

## 📞 技术支持

项目开发者：苏世鼎
项目名称：星际嗅探者 - 基于智能嗅觉的多星体气体探测任务

如有问题，请查看项目文档或联系开发者。

