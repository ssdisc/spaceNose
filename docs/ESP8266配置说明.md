# ESP8266与STM32连接配置说明

## 硬件连接

### USART2引脚连接（交叉连接）
- **STM32 PA2 (USART2_TX)** → **ESP8266 RX**
- **STM32 PA3 (USART2_RX)** → **ESP8266 TX**
- **GND** → **GND**（共地）
- **ESP8266 VCC** → **3.3V**（注意：ESP8266工作电压为3.3V）

> ⚠️ **重要提示**：ESP8266的工作电压是3.3V，不要连接5V！

## 串口配置

### USART1 - 调试串口
- 引脚：PA9 (TX), PA10 (RX)
- 波特率：9600
- 用途：输出调试信息

### USART2 - ESP8266通信串口
- 引脚：PA2 (TX), PA3 (RX)
- 波特率：115200（ESP8266默认波特率）
- 用途：与ESP8266进行AT指令通信

## 代码功能

### 初始化函数
```c
MX_USART2_UART_Init();  // 初始化USART2，配置为115200波特率
```

### ESP8266测试函数
```c
ESP8266_Test();  // 发送AT指令测试ESP8266连接
```

程序会在启动时自动发送`AT`指令测试ESP8266的连接状态，并通过USART1将结果输出到调试串口。

## 测试步骤

1. **硬件连接**
   - 按照上述引脚连接STM32和ESP8266
   - 确保ESP8266已正确供电（3.3V）
   - 确保共地连接

2. **编译上传**
   ```bash
   pio run -t upload
   ```

3. **查看调试信息**
   ```bash
   pio device monitor
   ```

4. **预期输出**
   ```
   ========================================
     星际嗅探者 - 传感器系统启动
     STM32F407ZGT6 @ 168 MHz
     Developer: 苏世鼎
   ========================================

   正在测试ESP8266连接...
   [发送] AT
   [接收] OK
   ESP8266连接成功！
   ```

## 常见问题排查

### 1. ESP8266无响应
- 检查硬件连接是否正确（TX/RX交叉连接）
- 检查ESP8266供电是否正常（3.3V，电流充足）
- 检查ESP8266的波特率是否为115200
- 尝试重启ESP8266

### 2. 乱码或通信异常
- 检查波特率设置是否正确
- 确保共地连接良好
- 检查TX/RX连接是否交叉

### 3. ESP8266波特率不匹配
如果ESP8266的波特率不是115200，需要修改`src/main.c`中的配置：
```c
huart2.Init.BaudRate = 9600;  // 修改为对应的波特率
```

常见的ESP8266波特率有：9600、57600、74880、115200

## 下一步开发建议

1. **实现完整的AT指令库**
   - 连接WiFi：`AT+CWJAP="SSID","PASSWORD"`
   - 创建TCP连接：`AT+CIPSTART`
   - 发送数据：`AT+CIPSEND`

2. **使用中断接收**
   - 当前使用阻塞式接收，建议改为中断或DMA接收
   - 提高响应速度和系统效率

3. **实现数据上传**
   - 将传感器数据通过ESP8266上传到云平台
   - 实现远程监控功能

## 参考资料
- [ESP8266 AT指令手册](https://www.espressif.com/sites/default/files/documentation/4a-esp8266_at_instruction_set_cn.pdf)
- STM32F407ZGT6数据手册

