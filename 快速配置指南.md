# ⚡ 快速配置指南

## 🎯 5分钟快速上手

### 第一步：修改STM32代码中的3个地方

打开 `src/main.c`，找到并修改以下内容：

#### 1. WiFi热点名称和密码（第112-113行）
```c
const char* wifi_ssid = "你的热点名称";      // 改这里！
const char* wifi_password = "你的热点密码";  // 改这里！
```

#### 2. 服务器IP地址（第124行）
```c
const char* server_ip = "192.168.137.1";  // 改成你电脑的IP地址！
```

**如何查看你的电脑IP地址？**
- 按 `Win + R` 输入 `cmd` 回车
- 输入 `ipconfig` 回车
- 找到 "无线局域网适配器" 下的 "IPv4 地址"
- 通常是 `192.168.137.1` 或 `192.168.43.1`

### 第二步：硬件连接

```
ESP8266 引脚    →    STM32F407 引脚
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TX             →    PA3 (UART2_RX)
RX             →    PA2 (UART2_TX)
VCC            →    3.3V (⚠️ 需要足够电流！)
GND            →    GND
CH_PD          →    3.3V (必须连接！)
```

**⚠️ 重要提醒：**
- ESP8266功耗较大，建议使用外部3.3V电源模块
- CH_PD引脚必须接3.3V，否则ESP8266无法工作

### 第三步：开启电脑WiFi热点

**Windows 10/11:**
1. 打开 设置 → 网络和Internet → 移动热点
2. 点击开关开启热点
3. 记住热点名称和密码（确保与STM32代码中一致）

### 第四步：启动后端服务器

#### 方法1：双击运行（推荐）
直接双击 `start_server.bat` 文件

#### 方法2：命令行运行
```bash
cd backend
pip install -r requirements.txt
python main.py
```

### 第五步：烧录STM32程序

使用PlatformIO或Keil编译并烧录程序到STM32

### 第六步：打开浏览器

访问 `http://localhost:8000` 查看实时数据！

---

## ✅ 成功标志

### STM32串口输出应该显示：
```
========================================
  星际嗅探者 - 传感器系统启动 (v2.0)
========================================

正在测试ESP8266连接...
✓ ESP8266响应正常！

正在连接WiFi热点...
✓ WiFi连接成功！

正在建立UDP连接...
✓ UDP连接建立成功！

系统初始化完成，进入主循环
[0] ADC_CH0: 2048, Voltage: 1.650 V
```

### 后端服务器应该显示：
```
========================================
  星际嗅探者 - 后端服务器启动
  HTTP服务: http://127.0.0.1:8000
  UDP服务: 0.0.0.0:8888
  WebSocket: ws://127.0.0.1:8000/ws
========================================
✓ UDP服务器启动在 0.0.0.0:8888
✓ WebSocket客户端已连接，当前连接数: 1
✓ 收到数据: {'counter': 0, 'adc': 2048, 'voltage': 1.65, 'timestamp': '...'}
```

### 前端页面应该显示：
- ✅ 连接状态指示灯为绿色
- ✅ 显示实时的ADC值和电压值
- ✅ 图表有数据点
- ✅ 数据日志不断更新

---

## ❌ 常见问题速查

### 问题1: ESP8266无响应
**可能原因：**
- 供电不足 → 使用外部3.3V电源
- CH_PD未接高电平 → 连接CH_PD到3.3V
- TX/RX接反 → 交叉连接（STM32 TX → ESP8266 RX）

### 问题2: WiFi连接失败
**可能原因：**
- 热点未开启 → 检查移动热点设置
- 密码错误 → 检查代码中的密码
- 5GHz频段 → ESP8266只支持2.4GHz，请改用2.4GHz热点

### 问题3: UDP数据无法到达
**可能原因：**
- IP地址错误 → 用ipconfig检查实际IP
- 防火墙阻止 → 允许Python程序通过防火墙
- 端口被占用 → 用 `netstat -an | findstr 8888` 检查

### 问题4: 前端显示未连接
**可能原因：**
- 服务器未启动 → 启动backend/main.py
- 端口冲突 → 检查8000端口是否被占用
- 浏览器不支持WebSocket → 使用Chrome/Edge/Firefox最新版

---

## 🎓 数据流向图解

```
┌─────────────────┐
│  STM32F407      │  读取ADC传感器数据
│  (传感器采集)    │  每秒采集一次
└────────┬────────┘
         │ UART串口 (115200)
         │ 发送JSON: {"counter":1, "adc":2048, "voltage":1.65}
         ↓
┌─────────────────┐
│  ESP8266        │  通过WiFi连接到热点
│  (WiFi模块)     │  建立UDP连接
└────────┬────────┘
         │ UDP协议
         │ 目标: 192.168.137.1:8888
         ↓
┌─────────────────┐
│  电脑WiFi热点   │  作为网络中继
│  (网络中心)     │  分配IP地址
└────────┬────────┘
         │ UDP Socket
         │ 接收来自ESP8266的数据
         ↓
┌─────────────────┐
│  FastAPI服务器  │  解析JSON数据
│  (Python后端)   │  添加时间戳
│  端口: 8000/8888│  转发给WebSocket客户端
└────────┬────────┘
         │ WebSocket
         │ ws://localhost:8000/ws
         ↓
┌─────────────────┐
│  Vue前端页面    │  实时显示数据
│  (浏览器)       │  绘制图表
│  http://...8000│  记录日志
└─────────────────┘
```

---

## 📱 测试数据传输

### 测试UDP连接
在电脑上使用Python测试UDP发送：
```python
import socket
import json

# 创建UDP socket
sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)

# 构造测试数据
data = {"counter": 999, "adc": 2048, "voltage": 1.65}
message = json.dumps(data)

# 发送到本地服务器
sock.sendto(message.encode(), ('127.0.0.1', 8888))
print(f"发送测试数据: {message}")
```

如果前端收到数据，说明UDP→WebSocket链路正常。

---

## 🔧 高级配置

### 修改UDP端口
如果8888端口被占用，可以修改：
1. `backend/main.py` 第49行: `UDP_PORT = 8888` → 改成其他端口
2. `src/main.c` 第125行: `uint16_t server_port = 8888;` → 改成相同端口

### 修改数据发送频率
`src/main.c` 第181行:
```c
HAL_Delay(1000);  // 1000毫秒 = 1秒，改小可以提高频率
```

### 添加更多传感器
在 `src/main.c` 主循环中添加更多ADC通道读取，并修改JSON格式。

---

## 💡 使用建议

1. **首次使用**: 建议先用USB串口监视器查看STM32的启动日志，确认每一步都成功
2. **调试模式**: 打开浏览器的开发者工具（F12），查看Console选项卡的WebSocket日志
3. **稳定运行**: 确保ESP8266供电稳定，电压不足会导致频繁断连
4. **网络延迟**: 正常情况下，数据从STM32到前端显示的延迟应该在100ms以内

---

## 🎉 完成！

现在你已经拥有了一个完整的物联网数据采集系统：
- ✅ STM32实时采集传感器数据
- ✅ ESP8266通过WiFi发送数据
- ✅ Python后端接收并转发数据
- ✅ Vue前端实时显示数据和图表

享受你的智能传感器监控系统吧！🚀

