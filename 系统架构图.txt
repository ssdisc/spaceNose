
╔═══════════════════════════════════════════════════════════════════════════════╗
║                    星际嗅探者 - 完整系统架构图                                  ║
║                    STM32 → ESP8266 → 电脑 → 前端                              ║
╚═══════════════════════════════════════════════════════════════════════════════╝


┌─────────────────────────────────────────────────────────────────────────────┐
│  第一层：硬件传感器层（STM32）                                                │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌───────────────────────────────────────┐
    │      STM32F407ZGT6 微控制器            │
    │  ┌─────────────────────────────────┐  │
    │  │   ADC传感器采集                   │  │
    │  │   • PA0: ADC_CH0 (传感器1)       │  │
    │  │   • 12位分辨率                   │  │
    │  │   • 采样频率: 1Hz                │  │
    │  └─────────────────────────────────┘  │
    │  ┌─────────────────────────────────┐  │
    │  │   数据处理                       │  │
    │  │   • ADC值转电压 (0-3.3V)        │  │
    │  │   • 构建JSON数据包               │  │
    │  │   • {"counter":N,"adc":X,"V":Y} │  │
    │  └─────────────────────────────────┘  │
    │  ┌─────────────────────────────────┐  │
    │  │   UART2串口通信                  │  │
    │  │   • PA2(TX) → ESP8266 RX        │  │
    │  │   • PA3(RX) ← ESP8266 TX        │  │
    │  │   • 波特率: 115200               │  │
    │  └─────────────────────────────────┘  │
    └───────────────────────────────────────┘
                     ↓
              (UART串口通信)
              发送JSON数据包
                     ↓

┌─────────────────────────────────────────────────────────────────────────────┐
│  第二层：无线通信层（ESP8266）                                                │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌───────────────────────────────────────┐
    │      ESP8266 WiFi模块                 │
    │  ┌─────────────────────────────────┐  │
    │  │   AT指令控制                     │  │
    │  │   • AT+CWMODE=1 (Station模式)   │  │
    │  │   • AT+CWJAP (连接WiFi热点)     │  │
    │  │   • AT+CIPSTART (建立UDP连接)   │  │
    │  └─────────────────────────────────┘  │
    │  ┌─────────────────────────────────┐  │
    │  │   UDP客户端                      │  │
    │  │   • 远程IP: 192.168.137.1       │  │
    │  │   • 远程端口: 8888              │  │
    │  │   • 本地端口: 5555              │  │
    │  └─────────────────────────────────┘  │
    │  ┌─────────────────────────────────┐  │
    │  │   数据转发                       │  │
    │  │   • 接收UART数据                │  │
    │  │   • 通过UDP发送到服务器          │  │
    │  └─────────────────────────────────┘  │
    └───────────────────────────────────────┘
                     ↓
              (WiFi无线网络)
               UDP数据包
                     ↓

┌─────────────────────────────────────────────────────────────────────────────┐
│  第三层：网络中继层（电脑WiFi热点）                                           │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌───────────────────────────────────────┐
    │      电脑WiFi热点                     │
    │  ┌─────────────────────────────────┐  │
    │  │   网络配置                       │  │
    │  │   • 热点IP: 192.168.137.1       │  │
    │  │   • SSID: 用户自定义             │  │
    │  │   • 频段: 2.4GHz (重要!)        │  │
    │  └─────────────────────────────────┘  │
    │  ┌─────────────────────────────────┐  │
    │  │   网络转发                       │  │
    │  │   • ESP8266分配IP               │  │
    │  │   • UDP包路由转发               │  │
    │  └─────────────────────────────────┘  │
    └───────────────────────────────────────┘
                     ↓
              (本地Socket)
                UDP 8888
                     ↓

┌─────────────────────────────────────────────────────────────────────────────┐
│  第四层：后端服务层（FastAPI + Python）                                       │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌───────────────────────────────────────┐
    │      FastAPI后端服务器                │
    │  ┌─────────────────────────────────┐  │
    │  │   UDP服务器 (端口8888)          │  │
    │  │   • 监听 0.0.0.0:8888           │  │
    │  │   • 接收ESP8266的数据           │  │
    │  │   • 解析JSON数据包              │  │
    │  │   • 添加时间戳                  │  │
    │  └─────────────────────────────────┘  │
    │             ↓                         │
    │  ┌─────────────────────────────────┐  │
    │  │   数据处理层                     │  │
    │  │   • JSON解析和验证              │  │
    │  │   • 数据格式转换                │  │
    │  │   • 错误处理和日志              │  │
    │  └─────────────────────────────────┘  │
    │             ↓                         │
    │  ┌─────────────────────────────────┐  │
    │  │   WebSocket服务器 (端口8000)    │  │
    │  │   • ws://0.0.0.0:8000/ws        │  │
    │  │   • 广播数据给所有客户端         │  │
    │  │   • 连接管理和心跳检测          │  │
    │  └─────────────────────────────────┘  │
    │  ┌─────────────────────────────────┐  │
    │  │   HTTP服务器 (端口8000)         │  │
    │  │   • 提供前端页面                │  │
    │  │   • REST API接口                │  │
    │  │   • /api/latest 最新数据        │  │
    │  └─────────────────────────────────┘  │
    └───────────────────────────────────────┘
                     ↓
            (WebSocket协议)
              实时数据推送
                     ↓

┌─────────────────────────────────────────────────────────────────────────────┐
│  第五层：前端展示层（Vue.js + Canvas）                                        │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌───────────────────────────────────────┐
    │      Vue前端应用                      │
    │  ┌─────────────────────────────────┐  │
    │  │   WebSocket客户端               │  │
    │  │   • 连接 ws://localhost:8000/ws │  │
    │  │   • 实时接收数据                │  │
    │  │   • 自动重连机制                │  │
    │  └─────────────────────────────────┘  │
    │  ┌─────────────────────────────────┐  │
    │  │   数据展示组件                  │  │
    │  │   • 📊 ADC原始值卡片            │  │
    │  │   • ⚡ 电压值卡片               │  │
    │  │   • 🔢 数据计数卡片             │  │
    │  └─────────────────────────────────┘  │
    │  ┌─────────────────────────────────┐  │
    │  │   数据可视化                    │  │
    │  │   • 📈 Canvas实时曲线图         │  │
    │  │   • 显示最近20个数据点          │  │
    │  │   • 自动缩放Y轴                 │  │
    │  └─────────────────────────────────┘  │
    │  ┌─────────────────────────────────┐  │
    │  │   数据日志                      │  │
    │  │   • 📝 滚动显示历史数据         │  │
    │  │   • 保留最近50条记录            │  │
    │  │   • 带时间戳和格式化显示        │  │
    │  └─────────────────────────────────┘  │
    └───────────────────────────────────────┘
                     ↓
              用户通过浏览器访问
             http://localhost:8000


╔═══════════════════════════════════════════════════════════════════════════════╗
║                           数据流向时序图                                       ║
╚═══════════════════════════════════════════════════════════════════════════════╝

时间线 →

T=0秒:  STM32采集ADC值 (例如: 2048)
        ↓
T=0.01: STM32转换为电压 (2048 → 1.650V)
        ↓
T=0.02: STM32构建JSON: {"counter":1,"adc":2048,"voltage":1.650}
        ↓
T=0.03: STM32通过UART发送给ESP8266
        ↓
T=0.05: ESP8266接收UART数据
        ↓
T=0.06: ESP8266通过UDP发送到服务器 (192.168.137.1:8888)
        ↓
T=0.08: 后端UDP服务器接收数据
        ↓
T=0.09: 后端解析JSON并添加时间戳
        ↓
T=0.10: 后端通过WebSocket广播给所有客户端
        ↓
T=0.11: 前端接收WebSocket数据
        ↓
T=0.12: 前端更新页面显示
        - 更新数据卡片
        - 添加图表数据点
        - 插入日志记录
        ↓
T=1秒:  重复循环（STM32每秒采集一次）


╔═══════════════════════════════════════════════════════════════════════════════╗
║                           网络拓扑图                                           ║
╚═══════════════════════════════════════════════════════════════════════════════╝

                    ┌──────────────────┐
                    │  电脑WiFi热点     │
                    │  192.168.137.1   │
                    │  (网关)          │
                    └────────┬─────────┘
                             │
             ┌───────────────┼───────────────┐
             │               │               │
    ┌────────▼────────┐     │      ┌────────▼────────┐
    │  ESP8266        │     │      │  后端服务器     │
    │  192.168.137.X  │     │      │  192.168.137.1  │
    │  (UDP客户端)    │     │      │  (UDP服务器)    │
    │  端口: 5555     │─────┘      │  端口: 8888     │
    └─────────────────┘            └─────────┬───────┘
            ↑                                 │
            │ UART                            │ WebSocket
            │                                 ↓
    ┌───────┴────────┐            ┌──────────────────┐
    │  STM32F407     │            │  浏览器客户端     │
    │  (传感器采集)   │            │  (前端显示)      │
    └────────────────┘            └──────────────────┘


╔═══════════════════════════════════════════════════════════════════════════════╗
║                           端口使用说明                                         ║
╚═══════════════════════════════════════════════════════════════════════════════╝

STM32端:
  • UART1 (115200): 调试串口 → 查看日志
  • UART2 (115200): ESP8266通信 → 发送数据

ESP8266端:
  • 本地端口: 5555 (UDP)
  • 目标端口: 8888 (UDP)

服务器端:
  • UDP端口: 8888 (接收ESP8266数据)
  • HTTP端口: 8000 (提供网页服务)
  • WebSocket端口: 8000 (实时推送数据)

浏览器端:
  • 访问: http://localhost:8000
  • WebSocket: ws://localhost:8000/ws


╔═══════════════════════════════════════════════════════════════════════════════╗
║                           配置检查清单                                         ║
╚═══════════════════════════════════════════════════════════════════════════════╝

硬件连接:
  ☐ STM32 PA2(TX) → ESP8266 RX
  ☐ STM32 PA3(RX) ← ESP8266 TX
  ☐ STM32 GND → ESP8266 GND
  ☐ ESP8266 VCC → 3.3V (足够电流!)
  ☐ ESP8266 CH_PD → 3.3V (必须!)

软件配置:
  ☐ main.c中修改WiFi热点名称和密码
  ☐ main.c中修改服务器IP地址
  ☐ 电脑开启WiFi热点 (2.4GHz)
  ☐ 安装Python依赖: pip install -r requirements.txt
  ☐ 启动后端服务器: python backend/main.py

网络检查:
  ☐ 运行 check_network.bat 查看IP
  ☐ 确认UDP端口8888未被占用
  ☐ 确认HTTP端口8000未被占用
  ☐ 防火墙允许Python程序通信

测试步骤:
  ☐ STM32串口显示 "✓ ESP8266响应正常"
  ☐ STM32串口显示 "✓ WiFi连接成功"
  ☐ STM32串口显示 "✓ UDP连接建立成功"
  ☐ 服务器显示 "✓ 收到数据: {...}"
  ☐ 浏览器状态指示灯变绿
  ☐ 页面数据实时更新


╔═══════════════════════════════════════════════════════════════════════════════╗
║                    技术栈总览                                                  ║
╚═══════════════════════════════════════════════════════════════════════════════╝

嵌入式层:
  • 语言: C
  • 框架: STM32 HAL库
  • IDE: PlatformIO / Keil

通信层:
  • 协议: UART, UDP, WebSocket
  • 数据格式: JSON
  • WiFi模块: ESP8266

后端层:
  • 语言: Python 3.8+
  • 框架: FastAPI
  • 服务器: Uvicorn
  • 异步: asyncio

前端层:
  • 框架: Vue.js 2.x
  • 语言: JavaScript (ES6+)
  • 样式: CSS3
  • 绘图: Canvas API


╔═══════════════════════════════════════════════════════════════════════════════╗
║                    项目文件结构                                                ║
╚═══════════════════════════════════════════════════════════════════════════════╝

spaceNose/
├── src/                          # STM32源代码
│   ├── main.c                    # 主程序（采集+发送）
│   ├── esp8266_driver.c          # ESP8266驱动（UDP通信）
│   ├── esp8266_driver.h          # 驱动头文件
│   ├── stm32f4xx_hal_msp.c      # HAL底层配置
│   └── stm32f4xx_it.c           # 中断处理
├── backend/                      # 后端服务器
│   ├── main.py                   # FastAPI服务器（UDP+WebSocket）
│   └── requirements.txt          # Python依赖
├── web/                          # 前端应用
│   ├── src/
│   │   ├── App.vue              # Vue主组件（实时显示）
│   │   └── main.js              # 入口文件
│   ├── dist/                     # 构建产物
│   └── package.json              # npm依赖
├── 快速配置指南.md               # ⚡ 5分钟快速上手
├── 使用说明.md                   # 📖 完整文档
├── 系统架构图.txt                # 📐 本文件
├── start_server.bat              # 启动脚本
├── check_network.bat             # 网络检查工具
└── README.md                     # 项目说明


═══════════════════════════════════════════════════════════════════════════════
              星际嗅探者团队 | 基于智能嗅觉的多星体气体探测任务
═══════════════════════════════════════════════════════════════════════════════

